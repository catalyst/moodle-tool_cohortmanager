define("tool_cohortmanager/condition_form",["exports","core/ajax","core/templates","core/fragment","core/modal_events","core/modal_factory","core/str"],(function(_exports,_ajax,_templates,_fragment,_modal_events,_modal_factory,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Condition modal form.
   *
   * @module     tool_cohortmanager/condition_form
   * @copyright  2022 Catalyst IT
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_fragment=_interopRequireDefault(_fragment),_modal_events=_interopRequireDefault(_modal_events),_modal_factory=_interopRequireDefault(_modal_factory);var SELECTORS_ADD_CONDITION_BUTTON="#id_conditionmodalbutton",SELECTORS_SELECT_CONDITION="#id_condition",SELECTORS_CONDITIONS_LIST="#conditions",SELECTORS_RULE_FROM_CONDITIONS_ELEMENT="#id_conditionjson",SELECTORS_RULE_FROM_CONDITIONS_CHANGED_ELEMENT="#id_isconditionschanged",SELECTORS_CONDITIONS_NOT_SAVED_WARNING="#tool-cohortmanager-not-saved",SELECTORS_CONDITION_EDIT_ACTION="tool-cohortmanager-condition-edit",SELECTORS_CONDITION_DELETE_ACTION="tool-cohortmanager-condition-delete";_exports.init=function(){var addButton=document.querySelector(SELECTORS_ADD_CONDITION_BUTTON),conditionSelect=document.querySelector(SELECTORS_SELECT_CONDITION);addButton.addEventListener("click",(function(e){e.preventDefault();var className=conditionSelect.value;""!==className&&displayModalForm(className,"")})),applyConditionActions()};var getModalFormBody=function(className,submittedData,defaults){void 0===defaults&&(defaults="");var params={classname:className,jsonformdata:JSON.stringify(submittedData),defaults:JSON.stringify(defaults)};return _fragment.default.loadFragment("tool_cohortmanager","condition_form",1,params)},displayModalForm=function(className,defaults){void 0===defaults&&(defaults=""),_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:(0,_str.get_string)("conditionformtitle","tool_cohortmanager"),body:getModalFormBody(className,"",defaults),large:!0}).then((function(modal){modal.getRoot().on(_modal_events.default.save,(function(e){e.preventDefault(),modal.getRoot().find("form").submit()})),modal.getRoot().on(_modal_events.default.hidden,(function(){modal.destroy()})),modal.getRoot().on("submit","form",(function(e){e.preventDefault(),submitModalFormAjax(className,modal)})),modal.show()}))},submitModalFormAjax=function(className,modal){var changeEvent=document.createEvent("HTMLEvents");changeEvent.initEvent("change",!0,!0),modal.getRoot().find(":input").each((function(index,element){element.dispatchEvent(changeEvent)}));var invalid=modal.getRoot().find('[aria-invalid="true"]');if(invalid.length)invalid.first().focus();else{var submittedData=modal.getRoot().find("form").serialize();_ajax.default.call([{methodname:"tool_cohortmanager_submit_condition_form",args:{classname:className,jsonformdata:JSON.stringify(submittedData)},done:function(response){updateCondition(response),renderConditions(getConditions()),modal.destroy()},fail:function(){modal.setBody(getModalFormBody(className,submittedData,""))}}])}},updateCondition=function(data){var condition={id:data.id,position:data.position,classname:data.classname,description:data.description,configdata:data.configdata,name:data.name},conditions=getConditions();condition.position>=0?conditions[condition.position]=condition:(conditions.push(condition),condition.position=conditions.length-1),saveConditionsToRuleForm(conditions)},getConditions=function(){var conditions=[],conditionsjson=document.querySelector("#id_conditionjson").value;return""!==conditionsjson&&(conditions=JSON.parse(conditionsjson)),conditions},saveConditionsToRuleForm=function(conditions){document.querySelector(SELECTORS_RULE_FROM_CONDITIONS_ELEMENT).setAttribute("value",JSON.stringify(conditions)),document.querySelector(SELECTORS_RULE_FROM_CONDITIONS_CHANGED_ELEMENT).setAttribute("value",1)},renderConditions=function(conditions){_templates.default.render("tool_cohortmanager/conditions",{conditions:conditions}).then((function(html){document.querySelector(SELECTORS_CONDITIONS_LIST).innerHTML=html,applyConditionActions(),document.querySelector(SELECTORS_CONDITIONS_NOT_SAVED_WARNING).classList.remove("hidden")})).fail((function(){Notification.exception({message:"Error updating conditions"})}))},applyConditionActions=function(){for(var deleteActions=document.getElementsByClassName(SELECTORS_CONDITION_DELETE_ACTION),_loop=function(i){deleteActions[i].addEventListener("click",(function(){var conditions=getConditions(),position=deleteActions[i].dataset.position;conditions.splice(position,1),position<=conditions.length&&conditions.slice(position).forEach((function(condition){condition.position=condition.position-1})),saveConditionsToRuleForm(conditions),renderConditions(conditions)}))},i=0;i<deleteActions.length;i++)_loop(i);for(var editActions=document.getElementsByClassName(SELECTORS_CONDITION_EDIT_ACTION),_loop2=function(_i){editActions[_i].addEventListener("click",(function(){var condition=getConditions()[editActions[_i].dataset.position];displayModalForm(condition.classname,condition)}))},_i=0;_i<editActions.length;_i++)_loop2(_i)}}));

//# sourceMappingURL=condition_form.min.js.map