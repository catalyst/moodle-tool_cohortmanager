define("tool_cohortmanager/condition_form",["exports","core/ajax","core/templates","core/fragment","core/modal_events","core/modal_factory","core/str"],(function(_exports,_ajax,_templates,_fragment,_modal_events,_modal_factory,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Condition modal form.
   *
   * @module     tool_cohortmanager/condition_form
   * @copyright  2022 Catalyst IT
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_fragment=_interopRequireDefault(_fragment),_modal_events=_interopRequireDefault(_modal_events),_modal_factory=_interopRequireDefault(_modal_factory);const SELECTORS_ADD_CONDITION_BUTTON="#id_conditionmodalbutton",SELECTORS_SELECT_CONDITION="#id_condition",SELECTORS_CONDITIONS_LIST="#conditions",SELECTORS_RULE_FORM_CONDITIONS_JSON="#id_conditionjson",SELECTORS_RULE_FORM_IS_CONDITIONS_CHANGED="#id_isconditionschanged",SELECTORS_CONDITIONS_NOT_SAVED_WARNING="#tool-cohortmanager-not-saved",SELECTORS_CONDITION_EDIT_ACTION="tool-cohortmanager-condition-edit",SELECTORS_CONDITION_DELETE_ACTION="tool-cohortmanager-condition-delete",SELECTORS_CONDITIONS="tool-cohortmanager-conditions";_exports.init=()=>{const addButton=document.querySelector(SELECTORS_ADD_CONDITION_BUTTON),conditionSelect=document.querySelector(SELECTORS_SELECT_CONDITION);addButton.addEventListener("click",(e=>{e.preventDefault();const className=conditionSelect.value;""!==className&&displayModalForm(className,"")})),applyConditionActions()};const getModalFormBody=(className,submittedData,defaults)=>{void 0===defaults&&(defaults="");const params={classname:className,jsonformdata:JSON.stringify(submittedData),defaults:JSON.stringify(defaults)};return _fragment.default.loadFragment("tool_cohortmanager","condition_form",1,params)},displayModalForm=(className,defaults)=>{void 0===defaults&&(defaults=""),_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:(0,_str.get_string)("conditionformtitle","tool_cohortmanager"),body:getModalFormBody(className,"",defaults),large:!0}).then((function(modal){modal.getRoot().on(_modal_events.default.save,(function(e){e.preventDefault(),modal.getRoot().find("form").submit()})),modal.getRoot().on(_modal_events.default.hidden,(function(){modal.destroy()})),modal.getRoot().on("submit","form",(function(e){e.preventDefault(),submitModalFormAjax(className,modal)})),modal.show()}))},submitModalFormAjax=(className,modal)=>{const changeEvent=document.createEvent("HTMLEvents");changeEvent.initEvent("change",!0,!0),modal.getRoot().find(":input").each((function(index,element){element.dispatchEvent(changeEvent)}));const invalid=modal.getRoot().find('[aria-invalid="true"]');if(invalid.length)invalid.first().focus();else{const submittedData=modal.getRoot().find("form").serialize();_ajax.default.call([{methodname:"tool_cohortmanager_submit_condition_form",args:{classname:className,jsonformdata:JSON.stringify(submittedData)},done:function(response){updateCondition(response),renderConditions(getConditions()),modal.destroy()},fail:function(){modal.setBody(getModalFormBody(className,submittedData,""))}}])}},updateCondition=data=>{let condition={...data},conditions=getConditions();condition.position>=0?conditions[condition.position]=condition:(conditions.push(condition),condition.position=conditions.length-1),saveConditionsToRuleForm(conditions)},getConditions=()=>{let conditions=[];const conditionsjson=document.querySelector(SELECTORS_RULE_FORM_CONDITIONS_JSON).value;return""!==conditionsjson&&(conditions=JSON.parse(conditionsjson)),conditions},saveConditionsToRuleForm=conditions=>{document.querySelector(SELECTORS_RULE_FORM_CONDITIONS_JSON).setAttribute("value",JSON.stringify(conditions)),document.querySelector(SELECTORS_RULE_FORM_IS_CONDITIONS_CHANGED).setAttribute("value",1)},renderConditions=conditions=>{_templates.default.render("tool_cohortmanager/conditions",{conditions:conditions}).then((function(html){document.querySelector(SELECTORS_CONDITIONS_LIST).innerHTML=html,applyConditionActions(),document.querySelector(SELECTORS_CONDITIONS_NOT_SAVED_WARNING).classList.remove("hidden")})).fail((function(){Notification.exception({message:"Error updating conditions"})}))},applyConditionActions=()=>{document.getElementsByClassName(SELECTORS_CONDITIONS)[0].addEventListener("click",(event=>{let element="SPAN"==event.target.tagName?event.target:event.target.parentNode;if(element.className==SELECTORS_CONDITION_DELETE_ACTION){let position=element.dataset.position,conditions=getConditions().filter((c=>c.position!=position)).map(((condition,index)=>({...condition,position:index})));saveConditionsToRuleForm(conditions),renderConditions(conditions)}if(element.className==SELECTORS_CONDITION_EDIT_ACTION){let position=element.dataset.position,condition=getConditions()[position];displayModalForm(condition.classname,condition)}}))}}));

//# sourceMappingURL=condition_form.min.js.map