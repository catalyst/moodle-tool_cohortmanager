{"version":3,"file":"condition_form.min.js","sources":["../src/condition_form.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Condition modal form.\n *\n * @module     tool_cohortmanager/condition_form\n * @copyright  2022 Catalyst IT\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Fragment from 'core/fragment';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport {get_string as getString} from 'core/str';\n\n/**\n * A list of used selectors.\n */\nconst SELECTORS = {\n    ADD_CONDITION_BUTTON: '#id_conditionmodalbutton',\n    SELECT_CONDITION: '#id_condition',\n    CONDITIONS_LIST: '#conditions',\n    RULE_FROM_CONDITIONS_ELEMENT: '#id_conditionjson',\n    RULE_FROM_CONDITIONS_CHANGED_ELEMENT: '#id_isconditionschanged',\n    CONDITIONS_NOT_SAVED_WARNING: '#tool-cohortmanager-not-saved',\n    CONDITION_EDIT_ACTION: 'tool-cohortmanager-condition-edit',\n    CONDITION_DELETE_ACTION: 'tool-cohortmanager-condition-delete',\n};\n\n/**\n * Init of the module.\n */\nexport const init = () => {\n    const addButton = document.querySelector(SELECTORS.ADD_CONDITION_BUTTON);\n    const conditionSelect = document.querySelector(SELECTORS.SELECT_CONDITION);\n\n    addButton.addEventListener('click', (e) => {\n        e.preventDefault();\n        const className = conditionSelect.value;\n        if (className !== '') {\n            displayModalForm(className, '');\n        }\n    });\n    applyConditionActions();\n};\n\n/**\n * Get modal form html body using fragment API.\n *\n * @param {string} className\n * @param {string} submittedData Submitted form data.\n * @param {any} defaults Default values for the form\n * @returns {Deferred|*}\n */\nconst getModalFormBody = (className, submittedData, defaults) => {\n    if (defaults === undefined) {\n        defaults = '';\n    }\n\n    const params = {\n        classname: className,\n        jsonformdata: JSON.stringify(submittedData),\n        defaults: JSON.stringify(defaults),\n    };\n\n    return Fragment.loadFragment('tool_cohortmanager', 'condition_form', 1, params);\n};\n\n/**\n * Display Modal form.\n *\n * @param {string} className\n * @param {any} defaults Default values for the form\n */\nconst displayModalForm = (className, defaults) => {\n\n    if (defaults === undefined) {\n        defaults = '';\n    }\n\n    ModalFactory.create({\n        type: ModalFactory.types.SAVE_CANCEL,\n        title: getString('conditionformtitle', 'tool_cohortmanager'),\n        body: getModalFormBody(className, '', defaults),\n        large: true,\n    }).then(function (modal) {\n\n        modal.getRoot().on(ModalEvents.save, function(e) {\n            e.preventDefault();\n            modal.getRoot().find('form').submit();\n        });\n\n        modal.getRoot().on(ModalEvents.hidden, function() {\n            modal.destroy();\n        });\n\n        modal.getRoot().on('submit', 'form', function(e) {\n            e.preventDefault();\n            submitModalFormAjax(className, modal);\n        });\n\n        modal.show();\n    });\n};\n\n/**\n * Submit modal form via ajax.\n *\n * @param {string} className Condition class name.\n * @param {object} modal Modal object.\n */\nconst submitModalFormAjax = (className, modal) => {\n    const changeEvent = document.createEvent('HTMLEvents');\n    changeEvent.initEvent('change', true, true);\n\n    // Prompt all inputs to run their validation functions.\n    // Normally this would happen when the form is submitted, but\n    // since we aren't submitting the form normally we need to run client side\n    // validation.\n    modal.getRoot().find(':input').each(function(index, element) {\n        element.dispatchEvent(changeEvent);\n    });\n\n    const invalid = modal.getRoot().find('[aria-invalid=\"true\"]');\n\n    // If we found invalid fields, focus on the first one and do not submit via ajax.\n    if (invalid.length) {\n        invalid.first().focus();\n    } else {\n        const submittedData = modal.getRoot().find('form').serialize();\n\n        Ajax.call([{\n            methodname: 'tool_cohortmanager_submit_condition_form',\n            args: {classname: className, jsonformdata: JSON.stringify(submittedData)},\n            done: function (response) {\n                updateCondition(response);\n                renderConditions(getConditions());\n                modal.destroy();\n            },\n            fail: function () {\n                modal.setBody(getModalFormBody(className, submittedData, ''));\n            }\n        }]);\n    }\n};\n\n/**\n * Update condition with provided data.\n *\n * @param {array} data Updated condition data.\n */\nconst updateCondition = (data) => {\n    let condition = {\n        id: data.id,\n        position: data.position,\n        classname: data.classname,\n        description: data.description,\n        configdata: data.configdata,\n        name: data.name,\n    };\n\n    let conditions = getConditions();\n\n    if (condition.position >= 0) {\n        conditions[condition.position] = condition;\n    } else {\n        conditions.push(condition);\n        condition.position = conditions.length - 1;\n    }\n\n    saveConditionsToRuleForm(conditions);\n};\n\n/**\n * Get a list of all conditions.\n *\n * @returns {*[]}\n */\nconst getConditions = () => {\n    let conditions = [];\n    const conditionsjson = document.querySelector('#id_conditionjson').value;\n    if (conditionsjson !== '') {\n        conditions = JSON.parse(conditionsjson);\n    }\n    return conditions;\n\n};\n\n/**\n * Save a list of conditions to a rule form element.\n *\n * @param {array} conditions A list of conditions to save\n */\nconst saveConditionsToRuleForm = (conditions) => {\n    document.querySelector(SELECTORS.RULE_FROM_CONDITIONS_ELEMENT).setAttribute('value', JSON.stringify(conditions));\n    document.querySelector(SELECTORS.RULE_FROM_CONDITIONS_CHANGED_ELEMENT).setAttribute('value', 1);\n};\n\n/**\n * Display a warning that conditions are not saved.\n */\nconst displayNotSavedWarning = () => {\n    document.querySelector(SELECTORS.CONDITIONS_NOT_SAVED_WARNING).classList.remove('hidden');\n};\n\n/**\n * Render conditions.\n *\n * @param {array} conditions A list of conditions to render.\n */\nconst renderConditions = (conditions) => {\n    Templates.render(\n        'tool_cohortmanager/conditions',\n        {'conditions' : conditions}\n    ).then(function(html) {\n        document.querySelector(SELECTORS.CONDITIONS_LIST).innerHTML = html;\n        applyConditionActions();\n        displayNotSavedWarning();\n    }).fail(function() {\n        Notification.exception({message: 'Error updating conditions'});\n    });\n};\n\n/**\n * Apply actions to conditions.\n */\nconst applyConditionActions = () => {\n\n    // Delete actions.\n    const deleteActions = document.getElementsByClassName(SELECTORS.CONDITION_DELETE_ACTION);\n    for (let i = 0; i < deleteActions.length; i++) {\n        deleteActions[i].addEventListener('click', () => {\n            let conditions = getConditions();\n            let position = deleteActions[i].dataset.position;\n            conditions.splice(position, 1);\n\n            if (position <= conditions.length) {\n                conditions.slice(position).forEach(\n                    function(condition) {\n                        condition.position = condition.position - 1;\n                    }\n                );\n            }\n\n            saveConditionsToRuleForm(conditions);\n            renderConditions(conditions);\n        });\n    }\n\n    // Edit actions.\n    const editActions = document.getElementsByClassName(SELECTORS.CONDITION_EDIT_ACTION);\n    for (let i = 0; i < editActions.length; i++) {\n        editActions[i].addEventListener('click', () => {\n            let conditions = getConditions();\n            let conditionPosition = editActions[i].dataset.position;\n            let condition = conditions[conditionPosition];\n\n            displayModalForm(condition.classname, condition);\n        });\n    }\n};\n"],"names":["SELECTORS","addButton","document","querySelector","conditionSelect","addEventListener","e","preventDefault","className","value","displayModalForm","applyConditionActions","getModalFormBody","submittedData","defaults","undefined","params","classname","jsonformdata","JSON","stringify","Fragment","loadFragment","create","type","ModalFactory","types","SAVE_CANCEL","title","body","large","then","modal","getRoot","on","ModalEvents","save","find","submit","hidden","destroy","submitModalFormAjax","show","changeEvent","createEvent","initEvent","each","index","element","dispatchEvent","invalid","length","first","focus","serialize","call","methodname","args","done","response","updateCondition","renderConditions","getConditions","fail","setBody","data","condition","id","position","description","configdata","name","conditions","push","saveConditionsToRuleForm","conditionsjson","parse","setAttribute","render","html","innerHTML","classList","remove","Notification","exception","message","deleteActions","getElementsByClassName","i","dataset","splice","slice","forEach","editActions"],"mappings":"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"}